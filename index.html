<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BotPad - Minimal GitHub Editor</title>
  <style>
    :root {
      --bg: #0c0f12;
      --panel: #141820;
      --text: #dbe3ea;
      --muted: #9aa6b2;
      --accent: #67e8f9;
      --accent-2: #7dd3fc;
      --danger: #f87171;
      --ok: #34d399;
      --btn: #1f2733;
      --border: #283243;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; background:var(--bg); color:var(--text); font-family: var(--mono); line-height:1.45; }
    .bar{ display:flex; gap:12px; align-items:center; padding:12px; background:var(--panel); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10; font-size:16px; }
    .bar input[type="text"], .bar textarea{ background:#0b1220; color:var(--text); border:1px solid var(--border); padding:10px 12px; border-radius:10px; font-family:var(--mono); font-size:16px; min-width: 320px; }
    .btn{ background:var(--btn); color:var(--text); border:1px solid var(--border); padding:14px 18px; border-radius:14px; cursor:pointer; font-weight:700; font-size:16px; user-select:none; }
    .btn.primary{ background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:#051018; border:none; }
    .btn.danger{ background:#310b0b; color:#ffd3d3; border:1px solid #5b1d1d; }
    .btn:active{ transform:translateY(1px) }
    .pill{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#0b1220; color:var(--muted); font-size:14px }
    .grid{ display:grid; grid-template-columns: 320px 1fr; gap:0; height: calc(100vh - 64px); }
    .left{ border-right:1px solid var(--border); overflow:auto; padding:12px; background: #0b1220; }
    .right{ display:flex; flex-direction:column; }
    .editor{ flex:1; display:flex; }
    .editor textarea{ width:100%; height:100%; padding:16px; font-size:16px; background:#060a12; color:var(--text); outline:none; border:none; resize:none; font-family:var(--mono); }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .muted{ color:var(--muted) }
    .files div{ padding:8px 10px; cursor:pointer; border-radius:8px; }
    .files div:hover{ background:#0e1524; }
    .files .active{ background:#101a2c; border:1px solid var(--border) }
    .footer{ border-top:1px solid var(--border); padding:10px; display:flex; gap:8px; align-items:center; background:var(--panel); }
    .commit{ flex:1; background:#0b1220; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
    .tag{ font-size:12px; color:var(--muted) }
    .section{ padding:10px; border-top:1px dashed var(--border); }
    .section h4{ margin:0 0 8px 0 }
    .right small{ color:var(--muted) }
    .kbd{border:1px solid var(--border); padding:2px 6px; border-radius:6px; background:#0b1220}
    .ok{ color: var(--ok) }
    .err{ color: var(--danger) }
  </style>
</head>
<body>
  <div class="bar">
    <span class="pill">Auth: <b>GitHub App</b></span>
    <input id="repo" type="text" placeholder="owner/repo" title="owner/repo, for example octocat/Hello-World">
    <button id="connect" class="btn primary">Connect</button>
    <button id="pull" class="btn">Pull</button>
    <button id="new" class="btn">New File</button>
    <button id="save" class="btn ok">Save</button>
    <button id="delete" class="btn danger">Delete</button>
    <span class="pill" id="status">Not connected</span>
  </div>
  <div class="grid">
    <div class="left">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <div><b>Files</b> <span class="tag" id="repoTag"></span></div>
        <div class="tag">Branch: <span id="branchTag">-</span></div>
      </div>
      <div class="files" id="files"></div>
      <div class="section">
        <h4>.env store</h4>
        <textarea id="env" rows="8" style="width:100%;background:#060a12;color:#e2e8f0;border:1px solid var(--border);border-radius:8px"></textarea>
        <div class="row" style="margin-top:8px">
          <button id="envLoad" class="btn">Load .env</button>
          <button id="envSave" class="btn">Save .env</button>
          <small>Backed by D1, for testing only</small>
        </div>
      </div>
      <div class="section">
        <h4>Optional PAT (testing)</h4>
        <textarea id="token" rows="3" placeholder="Leave blank to use GitHub App" style="width:100%;background:#060a12;color:#e2e8f0;border:1px solid var(--border);border-radius:8px"></textarea>
        <small>If present, the client will use PAT mode. We trim whitespace.</small>
      </div>
    </div>
    <div class="right">
      <div class="row" style="gap:14px; padding:10px; border-bottom:1px solid var(--border)">
        <div>Current file: <span id="current">None</span></div>
        <div class="tag">SHA: <span id="sha">-</span></div>
      </div>
      <div class="editor">
        <textarea id="code" placeholder="Open a file, or click New File to start"></textarea>
      </div>
      <div class="footer">
        <input id="message" class="commit" type="text" placeholder="Commit message, for example: Update">
        <button id="saveAs" class="btn">Save As</button>
      </div>
    </div>
  </div>
<script>
const API_BASE = "https://botpad-api.whitakerdavid.workers.dev";
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const state = { repo:"", branch:"", files:[], mode:"app", token:"", currentPath:"", currentSha:"" };
function toast(msg, cls=""){ const s=$("#status"); s.textContent=msg; s.className="pill "+cls; }
function repoValid(r){ return /^[A-Za-z0-9_.-]+\/[A-Za-z0-9_.-]+$/.test(r); }
function modeFromToken(){ const t=$("#token").value.trim(); state.token=t; return t? "pat":"app"; }
async function api(path, init){ const res=await fetch(API_BASE+path,{...init,headers:{ "content-type":"application/json",...(init&&init.headers||{})}}); const text=await res.text(); let data; try{data=JSON.parse(text);}catch{data={raw:text}} if(!res.ok){ throw new Error((data&&data.error)||text||res.statusText);} return data; }
$("#connect").onclick = async () => {
  const repo=$("#repo").value.trim(); if(!repoValid(repo)){ alert("Use owner/repo"); return; }
  state.mode = modeFromToken();
  try{ const body={repo, mode:state.mode}; if(state.mode==="pat") body.token=state.token; const data=await api("/api/connect",{method:"POST", body:JSON.stringify(body)}); state.repo=repo; state.branch=data.branch||"main"; $("#repoTag").textContent=repo; $("#branchTag").textContent=state.branch; toast("Connected","ok"); }catch(e){ alert("Connect failed: "+e.message); }
};
$("#pull").onclick = async () => {
  if(!state.repo){ alert("Connect first"); return; }
  try{
    const u=new URL(API_BASE+"/api/tree"); u.searchParams.set("repo",state.repo); u.searchParams.set("branch",state.branch||"main"); u.searchParams.set("mode",state.mode); if(state.mode==="pat"&&state.token) u.searchParams.set("token",state.token);
    const data=await fetch(u).then(r=>r.json()); if(data.error) throw new Error(data.error);
    state.files=(data.tree||[]).filter(x=>x.type==="blob");
    const list=$("#files"); list.innerHTML=""; state.files.forEach(f=>{ const d=document.createElement("div"); d.textContent=f.path; d.onclick=()=>openFile(f.path); list.appendChild(d); });
    toast("Pulled "+state.files.length+" files","ok");
  }catch(e){ alert("Pull failed: "+e.message); }
};
async function openFile(path){
  const u=new URL(API_BASE+"/api/file"); u.searchParams.set("repo",state.repo); u.searchParams.set("branch",state.branch||"main"); u.searchParams.set("path",path); u.searchParams.set("mode",state.mode); if(state.mode==="pat"&&state.token) u.searchParams.set("token",state.token);
  const data=await fetch(u).then(r=>r.json()); if(data.error){ alert("Load failed: "+data.error); return; }
  $("#code").value=data.content||""; $("#current").textContent=path; $("#sha").textContent=data.sha||""; state.currentPath=path; state.currentSha=data.sha||"";
  $$("#files div").forEach(n=>n.classList.remove("active")); const el=$$("#files div").find(n=>n.textContent===path); if(el) el.classList.add("active");
}
$("#new").onclick = () => { $("#code").value=""; $("#current").textContent="untitled.txt"; $("#sha").textContent="-"; state.currentPath="untitled.txt"; state.currentSha=""; };
async function commit(path, content, message, sha){
  const body={ repo:state.repo, branch:state.branch||"main", path, content, message, sha, mode:state.mode };
  if(state.mode==="pat"&&state.token) body.token=state.token;
  const data=await api("/api/commit",{ method:"POST", body:JSON.stringify(body)}); return data;
}
$("#save").onclick = async () => {
  if(!state.repo){ alert("Connect first"); return; } if(!state.currentPath){ alert("No file selected"); return; }
  const msg=$("#message").value.trim()||"Update";
  try{ const res=await commit(state.currentPath,$("#code").value,msg,state.currentSha); toast("Saved","ok"); $("#sha").textContent=res.content?.sha||"-"; state.currentSha=res.content?.sha||""; $("#message").value=""; }catch(e){ alert("Save failed: "+e.message); }
};
$("#saveAs").onclick = async () => {
  if(!state.repo){ alert("Connect first"); return; } const path=prompt("New path, for example src/app.js", state.currentPath||"file.txt"); if(!path) return;
  const msg=$("#message").value.trim()||"Add file"; try{ await commit(path,$("#code").value,msg,""); await $("#pull").onclick(); $("#message").value=""; }catch(e){ alert("Save As failed: "+e.message); }
};
$("#delete").onclick = async () => {
  if(!state.repo||!state.currentPath||!state.currentSha){ alert("Open a file first"); return; }
  if(!confirm("Delete "+state.currentPath+"?")) return;
  try{
    const body={ repo:state.repo, branch:state.branch||"main", path:state.currentPath, sha:state.currentSha, message:"Delete "+state.currentPath, mode:state.mode };
    if(state.mode==="pat"&&state.token) body.token=state.token;
    await api("/api/delete",{ method:"POST", body:JSON.stringify(body)});
    toast("Deleted","ok"); await $("#pull").onclick(); $("#code").value=""; $("#current").textContent="None"; $("#sha").textContent="-"; state.currentPath=""; state.currentSha="";
  }catch(e){ alert("Delete failed: "+e.message); }
};
$("#envLoad").onclick = async () => {
  if (!state.repo) { alert("Connect first"); return; }
  const u = new URL(API_BASE + "/api/env");
  u.searchParams.set("repo", state.repo);
  u.searchParams.set("branch", state.branch || "main");
  const r = await fetch(u).then(r=>r.json());
  $("#env").value = r.content || "";
};
$("#envSave").onclick = async () => {
  if (!state.repo) { alert("Connect first"); return; }
  await api("/api/env", { method:"POST", body: JSON.stringify({ repo: state.repo, branch: state.branch || "main", content: $("#env").value })});
  toast(".env saved", "ok");
};
(function init(){ const last=localStorage.getItem("botpad_repo")||""; if(last) $("#repo").value=last; $("#repo").addEventListener("change", ()=>{ localStorage.setItem("botpad_repo", $("#repo").value.trim()); }); })();
</script>
</body>
</html>
